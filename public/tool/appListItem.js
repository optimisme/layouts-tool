class SdwToolListItem extends HTMLElement {

    constructor() {
        super()

        this.refApp = null
        this.ident = 0
        this.itemHeight = 25
        this.dragImage = new Image()

        this.shadow = this.attachShadow({ mode: 'open' })
    }

    attributeChangedCallback(name, oldValue, newValue) { }

    connectedCallback () {
        
        let identWidth = (this.ident * 16)

        this.elmStyle = document.createElement('style')
        this.elmStyle.textContent = `
        .root {
            overflow: hidden;
        }
        .main {
            align-items: center;
            box-sizing: border-box;
            cursor: pointer;
            display: flex;
            height: ${this.itemHeight}px;
            padding: 0 8px;
            width: 100%;
        }
        .main:hover {
            background-color: #ccc;
        }
        .selected {
            background-color: rgba(0, 125, 255, 0.2);
        }
        .main > div[name="ident"] {
            width: ${identWidth}px;
        }
        .main > div[name="arrow"] {
            display: none;
            transform: rotateZ(0deg);
            transition: transform 0.25s ease;
            width: 16px;
        }
        .expanded {
            transform: rotateZ(90deg) !important;
        }
        .main > div[name="description"] {
            flex-grow: 1;
            font-size: 0.75em;
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
            max-width: calc(100% - ${identWidth + 24}px)
        }
        .childs {
            transition: height 0.25s ease;
        }
        .dragOver {
            background-color: #f6e2b1;
        }`
        this.shadow.appendChild(this.elmStyle)

        this.elmRoot = document.createElement('div')
        this.elmRoot.setAttribute('class', `root`)

        if (this.refApp && this.refApp.parent != null) {
            this.elmRoot.setAttribute('draggable', `true`)
            this.elmRoot.addEventListener('dragstart', (e) => {
                e.stopPropagation()
                app.refDrag = this.refApp
                e.dataTransfer.setDragImage(this.dragImage, 10, 10)
            })
            this.elmRoot.addEventListener('dragend', (e) => {
                app.refDrag = null
            })
            this.setDragImage()
        }
        this.elmRoot.addEventListener('dragenter', (e) => {
            e.preventDefault()
            e.stopPropagation()
            if (app.canDrag(this.refApp)) {
                this.elmRoot.classList.add('dragOver')
            }
        })
        this.elmRoot.addEventListener('dragover', (e) => {
            e.preventDefault()
            e.stopPropagation()
            if (app.canDrag(this.refApp)) {
                this.elmRoot.classList.add('dragOver')
            }
        })
        this.elmRoot.addEventListener('dragleave', (e) => {
            e.preventDefault()
            e.stopPropagation()
            this.elmRoot.classList.remove('dragOver')
        })
        this.elmRoot.addEventListener('drop', (e) => {
            e.preventDefault()
            e.stopPropagation()
            this.elmRoot.classList.remove('dragOver')
            if (app.canDrag(this.refApp)) {
                app.moveAt(this.refApp, app.refDrag, 0)
            }
        })

            let divMain = document.createElement('div')
            divMain.setAttribute('name', 'main')
            divMain.setAttribute('class', 'main')
            divMain.addEventListener('click', (evt) => { 
                evt.stopPropagation()
                if (app.refSelected != null && app.refSelected == this.refApp) {
                    app.unselect()
                } else {
                    app.select(this.refApp)
                }
            })
            this.elmRoot.appendChild(divMain)

                let divIdent = document.createElement('div')
                divIdent.setAttribute('name', 'ident')
                divMain.appendChild(divIdent)

                let divArrow = document.createElement('div')
                divArrow.setAttribute('name', 'arrow')
                divArrow.addEventListener('click', (evt) => { 
                    evt.stopPropagation()
                    if (this.refApp.expanded) {
                        this.colapse()
                    } else {
                        this.expand()
                    }
                })
                divMain.appendChild(divArrow)

                    let arrowIcon = document.createElement('ion-icon')
                    arrowIcon.setAttribute('name', 'chevron-forward-outline')
                    divArrow.appendChild(arrowIcon)

                let divText = document.createElement('div')
                divText.setAttribute('name', 'description')
                divMain.appendChild(divText)

                    if (!app.elementsRoot  || app.elementsRoot.refList == null) {
                        divText.innerText = 'Body'
                    } else {
                        divText.innerText = this.refApp.description
                    }

            let divChilds = document.createElement('div')
            divChilds.setAttribute('name', 'childs')
            divChilds.setAttribute('class', 'childs')
            this.elmRoot.appendChild(divChilds)

        this.shadow.appendChild(this.elmRoot)
        this.innerHTML = ''
    }

    add (ref) {
        let newItem = document.createElement('sdw-tool-list-item')
        newItem.refApp = ref
        newItem.ident = this.ident + 1

        this.elmRoot.querySelector('div[name="childs"]').appendChild(newItem)
        this.elmRoot.querySelector('div[name="arrow"]').style.display = 'initial'

        if (this.refApp.parent == null) {
            this.expand()
        } else {
            this.setChildsHeight()
        }

        return newItem
    }

    remove (child) {
        this.elmRoot.querySelector('div[name="childs"]').removeChild(child)
        if (this.refApp.childs.length == 1) {
            this.colapse()
            this.elmRoot.querySelector('div[name="arrow"]').style.display = 'none'
        }
    }

    select () {
        this.elmRoot.querySelector('div[name="main"]').classList.add('selected')
    }

    unselect () {
        this.elmRoot.querySelector('div[name="main"]').classList.remove('selected')
    }

    expand () {
        this.refApp.expanded = true
        this.elmRoot.querySelector('div[name="arrow"]').classList.add('expanded')
        this.setChildsHeight()
    }

    colapse () {
        this.refApp.expanded = false
        this.elmRoot.querySelector('div[name="arrow"]').classList.remove('expanded')
        this.elmRoot.querySelector('div[name="childs"]').style.height = '0'
        if (this.refApp.parent !== null) {
            this.refApp.parent.refList.setChildsHeight()
        }
        // TODO: unselect child if selected
    }

    setChildsHeight () {
        let numChilds = this.getNumberOfExpandedChilds()
        this.elmRoot.querySelector('div[name="childs"]').style.height = (numChilds * this.itemHeight) + 'px'
        if (this.refApp.parent !== null) {
            this.refApp.parent.refList.setChildsHeight()
        }
    }

    getNumberOfExpandedChilds () {
        let rst = 0
        let child = null

        if (this.refApp.expanded) {
            for (let cnt = 0; cnt < this.refApp.childs.length; cnt = cnt + 1) {
                rst = rst + 1
                child = this.refApp.childs[cnt]
                if (child.refList != null) {
                    rst = rst + child.refList.getNumberOfExpandedChilds()
                }
            }
        }

        return rst
    }

    setDescription (value) {

        this.elmRoot.querySelector('div[name="description"]').textContent = value
        this.setDragImage()
    }

    setDragImage () {
        let cnv = document.createElement('canvas')
        cnv.setAttribute('height', 25)
        cnv.setAttribute('width', '150')
        let ctx = cnv.getContext("2d")
        ctx.fillStyle = 'white'
        ctx.fillRect(0, 0, 150, 25)
        ctx.fillStyle = 'grey'
        ctx.font = "12px 'Open Sans', Arial"
        let txt = this.refApp.description
        let width = ctx.measureText(txt).width
        let ellipsis = false
        while (width > 100) {
            txt = txt.slice(0, -1)
            width = ctx.measureText(txt).width
            ellipsis = true
        }
        if (ellipsis) {
            ctx.fillText(txt + '...', 25, 16)
        } else {
            ctx.fillText(txt, 25, 16)
        }
        
        ctx.lineWidth = 2
        ctx.strokeStyle = 'lightgrey'
        ctx.strokeRect(0, 0, 150, 25)

        this.dragImage = new Image()
        this.dragImage.src = cnv.toDataURL('image/jpeg', 1)
    }
}